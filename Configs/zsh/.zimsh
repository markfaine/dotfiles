# Zim configuration {{{

# Use degit instead of git as the default tool to install and update modules. {{{
#zstyle ':zim:zmodule' use 'degit'
# End Use degit instead of git as the default tool to install and update modules. }}}

# Module configuration {{{

# SSH zim module configuration {{{
# I currenlty only use files in WSL so this is disabled for non Windows Terminal
# sessions where I would use yubikey keys
# See ~/.zimrc `zmodule ssh`
if [[ "${WT_SESSION:-}" != "" ]]; then
    zstyle ':zim:ssh' ids 'id_rsa' 'id_bean-rsa' 
fi
# End SSH zim module configuration }}}

# Configure terminal title module {{{
# Requires termtitle module in .zimrc
zstyle ':zim:termtitle' hooks 'preexec' 'precmd'
zstyle ':zim:termtitle:preexec' format '${${(A)=1}[1]}'
zstyle ':zim:termtitle:precmd'  format '%1~'
# End Configure terminal title mddule }}}

# Configure git-info module {{{
# Requires git-info module in .zimrc
# See: https://github.com/zimfw/git-info
setopt nopromptbang prompt{cr,percent,sp,subst}
zstyle ':zim:git-info:branch' format 'branch:%b'
zstyle ':zim:git-info:commit' format 'commit:%c'
zstyle ':zim:git-info:remote' format 'remote:%R'
zstyle ':zim:git-info:keys' format \
    'prompt'  'git(%b%c)' \
    'rprompt' '[%R]'
autoload -Uz add-zsh-hook && add-zsh-hook precmd git-info
PS1='${(e)git_info[prompt]}%# '
RPS1='${(e)git_info[rprompt]}'
# End Configure git-info module }}}

# Configure prompt-pwd {{{
# See: https://github.com/zimfw/prompt-pwd
# Requires prompt-pwd module in .zimrc
setopt nopromptbang prompt{cr,percent,sp,subst}

zstyle ':zim:prompt-pwd' git-root yes
zstyle ':zim:prompt-pwd:fish-style' dir-length 1
zstyle ':zim:prompt-pwd:separator' format '❯'
PS1='$(prompt-pwd)❯ '
# End Configure prompt-pwd }}}

# Git module configuration {{{
# Set a custom prefix for the generated aliases. The default prefix is 'G'.
zstyle ':zim:git' aliases-prefix 'G'
# End Git Module configuration }}}

# Input module configuration {{{
# Append `../` to your input for each `.` you type after an initial `..`
zstyle ':zim:input' double-dot-expand yes
# End Input module configuration }}}

# Term title module configuration {{{
# Set a custom terminal title format using prompt expansion escape sequences.
# See http://zsh.sourceforge.net/Doc/Release/Prompt-Expansion.html#Simple-Prompt-Escapes
# If none is provided, the default '%n@%m: %~' is used.
#zstyle ':zim:termtitle' format '%1~'
zstyle ':zim:termtitle' hooks 'preexec' 'precmd'
zstyle ':zim:termtitle:preexec' format '${${(A)=1}[1]}'
zstyle ':zim:termtitle:precmd'  format '%1~'
# End Term title module configuration }}}

# zsh-autosuggestions module configuration {{{

# Disable automatic widget re-binding on each precmd. {{{
# This can be set when
# zsh-users/zsh-autosuggestions is the last module in your ~/.zimrc.
ZSH_AUTOSUGGEST_MANUAL_REBIND=1
# End Disable automatic widget re-binding on each precmd. }}}

# Set color for zsh-autosuggestions {{{
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=23'
# End Set color for zsh-autosuggestions }}}

# Customize the style that the suggestions are shown with {{{
# See https://github.com/zsh-users/zsh-autosuggestions/blob/master/README.md#suggestion-highlight-style
#ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=242'
# Customize the style that the suggestions are shown with }}}

# End zsh-autosuggestions module configuration }}}

# zsh-syntax-highlighting module configuration {{{

# Set what highlighters will be used. {{{
# See https://github.com/zsh-users/zsh-syntax-highlighting/blob/master/docs/highlighters.md
ZSH_HIGHLIGHT_HIGHLIGHTERS=(main brackets)
# Set what highlighters will be used. }}}

# End zsh-syntax-highlighting module configuration }}}

# Customize the main highlighter styles. {{{
# See https://github.com/zsh-users/zsh-syntax-highlighting/blob/master/docs/highlighters/main.md#how-to-tweak-it
#typeset -A ZSH_HIGHLIGHT_STYLES
#ZSH_HIGHLIGHT_STYLES[comment]='fg=242'
# End Customize the main highlighter styles. }}}
# End Module configuration }}}

# Setup modules {{{

ZIM_HOME=${ZDOTDIR:-${HOME}}/.zim
mkdir -p "$ZIM_HOME"

# Download zimfw plugin manager if missing. {{{
if [[ ! -e ${HOME}/zimfw.zsh ]]; then
  if (( ${+commands[curl]} )); then
    curl -fsSL -o ${HOME}/zimfw.zsh \
        https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh
  else
    wget -nv -O ${HOME}/zimfw.zsh \
        https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh
  fi
fi
# End Download zimfw plugin manager if missing. }}}

# Install missing modules, and update ${ZIM_HOME}/init.zsh if missing or outdated. {{{
if [[ ! ${ZIM_HOME}/init.zsh -nt ${ZDOTDIR:-${HOME}}/.zimrc ]]; then
  source ${HOME}/zimfw.zsh init -q
fi
# End Install missing modules, and update ${ZIM_HOME}/init.zsh if missing or outdated. }}}
#
# Initialize modules {{{
source ${ZIM_HOME}/init.zsh
# End Initialize modules }}}

# End Setup modules }}}

# Post-init module configuration {{{

# Bind ^[[A/^[[B manually so up/down works both before and after zle-line-init {{{
for key ('^[[A' '^P' ${terminfo[kcuu1]}) bindkey ${key} history-substring-search-up
for key ('^[[B' '^N' ${terminfo[kcud1]}) bindkey ${key} history-substring-search-down
for key ('k') bindkey -M vicmd ${key} history-substring-search-up
for key ('j') bindkey -M vicmd ${key} history-substring-search-down
unset key
# End Bind ^[[A/^[[B manually so up/down works both before and after zle-line-init }}}
# End Post-init module configuration }}}
# End Zim configuration }}}
